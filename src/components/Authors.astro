---
import type { Author } from "../types/types";

interface Props {
  authors: Author[];
}

const { authors } = Astro.props;

// Collect unique institutions and assign numbers
const institutionMap = new Map<string, number>();
const institutions: string[] = [];

authors.forEach((author) => {
  const normalizedInstitution = author.institution?.trim() || "";
  if (normalizedInstitution && !institutionMap.has(normalizedInstitution)) {
    const number = institutions.length + 1;
    institutionMap.set(normalizedInstitution, number);
    institutions.push(normalizedInstitution);
  }
});

// Prepare authors with institution numbers
const authorsWithNumbers = authors.map((author) => {
  const normalizedInstitution = author.institution?.trim() || "";
  const institutionNumber = normalizedInstitution ? institutionMap.get(normalizedInstitution) : undefined;
  return { ...author, institutionNumber };
});
---

<div class="flex flex-col gap-6 items-center text-center">
  {/* Authors row */}
  <div class="flex flex-row gap-x-3 flex-wrap justify-center items-baseline text-xl leading-relaxed">
    {
      authorsWithNumbers.map((author, index) => (
        <span class="flex flex-row items-baseline">
          {author.url ? (
            <a href={author.url} class="">
              {author.name}
            </a>
          ) : (
            author.name
          )}
          {author.notes && (
            <sup class="text-base leading-none ml-0.5">
              {author.notes.map(
                (note, noteIndex, array) =>
                  note + (noteIndex < array.length - 1 ? "," : "")
              )}
            </sup>
          )}
          {author.institutionNumber && (
            <sup class="text-sm leading-none ml-1 font-normal">{author.institutionNumber}</sup>
          )}
          {index < authorsWithNumbers.length - 1 && <span class="mx-1.5">,</span>}
        </span>
      ))
    }
  </div>
  
  {/* Institutions row */}
  {institutions.length > 0 && (
    <div class="flex flex-row gap-x-5 flex-wrap justify-center leading-relaxed">
      {
        institutions.map((institution, index) => (
          <span class="flex flex-row items-baseline">
            <sup class="text-sm leading-none mr-0.5 font-normal">{index + 1}</sup>
            <span>{institution}</span>
            {index < institutions.length - 1 && <span class="mx-1.5">,</span>}
          </span>
        ))
      }
    </div>
  )}
</div>
